# MacroCreator

ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ Windows è‡ªåŠ¨åŒ–å®å·¥å…·ï¼Œæ”¯æŒå½•åˆ¶ã€ç¼–è¾‘å’Œå›æ”¾é”®ç›˜é¼ æ ‡æ“ä½œï¼Œä»¥åŠé€šè¿‡è‡ªå®šä¹‰è„šæœ¬è¯­è¨€è¿›è¡Œé«˜çº§è‡ªåŠ¨åŒ–æ§åˆ¶ã€‚

## âœ¨ æ ¸å¿ƒåŠŸèƒ½

### ğŸ¯ å›¾å½¢åŒ–ç•Œé¢ (MacroCreator)
- **å½•åˆ¶å’Œå›æ”¾**ï¼šå½•åˆ¶é”®ç›˜å’Œé¼ æ ‡æ“ä½œåºåˆ—ï¼Œç²¾ç¡®å›æ”¾
- **å¯è§†åŒ–ç¼–è¾‘**ï¼šé€šè¿‡å›¾å½¢ç•Œé¢ç¼–è¾‘ã€è°ƒæ•´ã€é‡æ’äº‹ä»¶åºåˆ—
- **æµç¨‹æ§åˆ¶**ï¼šæ”¯æŒæ¡ä»¶åˆ¤æ–­ã€å¾ªç¯ã€è·³è½¬ç­‰é«˜çº§æ§åˆ¶æµ
- **é«˜ç²¾åº¦è®¡æ—¶**ï¼šä½¿ç”¨é«˜ç²¾åº¦è®¡æ—¶å™¨ç¡®ä¿äº‹ä»¶å›æ”¾çš„å‡†ç¡®æ€§
- **æ–‡ä»¶ç®¡ç†**ï¼šä¿å­˜å’ŒåŠ è½½å®åºåˆ—ä¸º XML æ–‡ä»¶

### ğŸ“œ è„šæœ¬è¯­è¨€ (MacroScript)
- **DSL ç¼–è¯‘å™¨**ï¼šè‡ªå®šä¹‰é¢†åŸŸç‰¹å®šè¯­è¨€ (DSL)ï¼Œç”¨äºç¼–å†™å¤æ‚çš„è‡ªåŠ¨åŒ–è„šæœ¬
    - DSLè¯­è¨€æ”¯æŒè§é¡¹ç›®ï¼š[vscode-macroscript-support](https://github.com/lovespite/vscode-macroscript-support)
- **å‘½ä»¤è¡Œå·¥å…·**ï¼šç¼–è¯‘ã€è¿è¡Œå’Œç®¡ç†å®è„šæœ¬
- **æ¡ä»¶æ§åˆ¶**ï¼šæ”¯æŒ `if/else/endif`ã€`while/endwhile` è¯­æ³•
- **åƒç´ æ£€æµ‹**ï¼šé€šè¿‡ `PixelColor` å‡½æ•°è¿›è¡Œå±å¹•åƒç´ é¢œè‰²åˆ¤æ–­
- **è‡ªå®šä¹‰è¡¨è¾¾å¼**ï¼šä½¿ç”¨ `Custom()` æ‰§è¡ŒåŠ¨æ€è¡¨è¾¾å¼
- **å†…è”è„šæœ¬**ï¼šä½¿ç”¨ `Script()` åµŒå…¥å¤æ‚é€»è¾‘

### ğŸ”Œ ç¡¬ä»¶é‡å®šå‘ (CH9329)
- **ç¡¬ä»¶æ¨¡æ‹Ÿ**ï¼šé€šè¿‡ CH9329 èŠ¯ç‰‡æ¨¡æ‹Ÿé”®ç›˜é¼ æ ‡è¾“å…¥
- **ä¸²å£é€šä¿¡**ï¼šæ”¯æŒé€šè¿‡ä¸²å£å°†è¾“å…¥é‡å®šå‘åˆ°å¤–éƒ¨è®¾å¤‡
- **HID è®¾å¤‡æ§åˆ¶**ï¼šå®ç° USB HID è®¾å¤‡çº§åˆ«çš„è¾“å…¥æ¨¡æ‹Ÿ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚
- Windows æ“ä½œç³»ç»Ÿ
- .NET 9.0 æˆ–æ›´é«˜ç‰ˆæœ¬

### ä½¿ç”¨å›¾å½¢ç•Œé¢

1. è¿è¡Œ `MacroCreator.exe`
2. ç‚¹å‡» **å¼€å§‹å½•åˆ¶** æŒ‰é’® (æˆ–æŒ‰ F11)
3. æ‰§è¡Œè¦å½•åˆ¶çš„æ“ä½œ
4. å†æ¬¡æŒ‰ F11 åœæ­¢å½•åˆ¶
5. ç‚¹å‡» **æ’­æ”¾** æŒ‰é’®å›æ”¾å½•åˆ¶çš„æ“ä½œ

**å‘½ä»¤è¡Œå‚æ•°ï¼š**
```bash
# æ‰“å¼€/ç¼–è¾‘å®æ–‡ä»¶
MacroCreator.exe open "path\to\macro.xml"
MacroCreator.exe edit "path\to\macro.xml"

# ç›´æ¥è¿è¡Œå®æ–‡ä»¶ï¼ˆæ— ç•Œé¢ï¼‰
MacroCreator.exe run "path\to\macro.xml"
```

### ä½¿ç”¨è„šæœ¬è¯­è¨€

**ç¼–è¯‘è„šæœ¬ï¼š**
```bash
MacroScript.exe compile "script.macroscript" --output "output.xml"
```

**è¿è¡Œè„šæœ¬ï¼š**
```bash
MacroScript.exe run "script.macroscript"
```

**é‡å®šå‘åˆ°ç¡¬ä»¶è®¾å¤‡ï¼š**
```bash
MacroScript.exe run "script.macroscript" --redirect COM3
```

**å…¶ä»–é€‰é¡¹ï¼š**
- `--pause` æˆ– `-p`ï¼šè¿è¡Œåæš‚åœï¼Œç­‰å¾…ç”¨æˆ·æŒ‰é”®
- `--hide`ï¼šè¿è¡Œæ—¶éšè—æ§åˆ¶å°çª—å£
- `--view` æˆ– `-v`ï¼šç¼–è¯‘ååœ¨ MacroCreator ä¸­æŸ¥çœ‹

## ğŸ“– è„šæœ¬è¯­è¨€è¯­æ³•

### åŸºæœ¬äº‹ä»¶

```macroscript
// é¼ æ ‡æ“ä½œ
MouseMoveTo(400, 400, 200)      // ç§»åŠ¨åˆ°ç»å¯¹åæ ‡ (400, 400)ï¼Œå»¶è¿Ÿ 200ms
MouseMove(50, -50, 100)          // ç›¸å¯¹ç§»åŠ¨ (50, -50)ï¼Œå»¶è¿Ÿ 100ms
MouseClick(Left, 100)            // å•å‡»å·¦é”®ï¼Œå»¶è¿Ÿ 100ms
MouseDown(Left, 50)              // æŒ‰ä¸‹å·¦é”®
MouseUp(Left, 20)                // é‡Šæ”¾å·¦é”®
MouseWheel(-100, 10)             // æ»šåŠ¨é¼ æ ‡æ»šè½®

// é”®ç›˜æ“ä½œ
KeyDown(LControlKey, 100)        // æŒ‰ä¸‹å·¦ Ctrl é”®
KeyUp(LControlKey, 50)           // é‡Šæ”¾å·¦ Ctrl é”®
KeyPress(LWin, R, 25)            // æŒ‰ä¸‹å¹¶é‡Šæ”¾ Win+R ç»„åˆé”®

// å»¶è¿Ÿ
Delay(1000)                      // æš‚åœ 1000ms
```

### æµç¨‹æ§åˆ¶

```macroscript
// æ¡ä»¶åˆ¤æ–­
if (PixelColor(10, 20) == RGB(255, 0, 0, 5))
    KeyPress(LWin, R, 25)
endif

// if-else
if (Custom(`now().Hour > 9`))
    Delay(1000)
else
    Delay(500)
endif

// ä¸ç­‰äºåˆ¤æ–­
if (PixelColor(0, 0) != RGB(0, 0, 0))
    MouseMoveTo(0, 0)
    exit
endif

// å¾ªç¯
while (PixelColor(100, 100) == RGB(255, 255, 255))
    MouseWheel(-100, 10)
    
    if (Custom(`now().Hour >= 17`))
        break
    endif
endwhile

// æ ‡ç­¾å’Œè·³è½¬
label MyStartPoint
MouseMove(0, 0, 100)
goto MyStartPoint
```

### å†…è”è„šæœ¬

```macroscript
Script(`
    // æ“ä½œå…¨å±€å˜é‡
    set("MyVar", 0)
    set("MyVar", (int)get("MyVar") + 1)
    println("MyVar is now: " + get("MyVar"))
`, "MyScript")
```

### åƒç´ é¢œè‰²æ£€æµ‹

```macroscript
// RGB(r, g, b, [tolerance])
// tolerance: é¢œè‰²å®¹å·® (é»˜è®¤ä¸º 0)

if (PixelColor(100, 200) == RGB(255, 0, 0, 5))
    // å¦‚æœåæ ‡ (100, 200) å¤„çš„åƒç´ é¢œè‰²æ¥è¿‘çº¢è‰²
    // (å®¹å·®èŒƒå›´ Â±5)
    MouseClick(Left)
endif
```

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
MacroCreator/
â”œâ”€â”€ MacroCreator/              # ä¸» WinForms åº”ç”¨ç¨‹åº
â”‚   â”œâ”€â”€ Controller/
â”‚   â”‚   â””â”€â”€ MacroController.cs # æ ¸å¿ƒæ§åˆ¶å™¨ï¼ˆå¤–è§‚æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ Forms/                 # çª—ä½“ç•Œé¢
â”‚   â”‚   â”œâ”€â”€ MainForm.cs        # ä¸»çª—å£
â”‚   â”‚   â”œâ”€â”€ EditKeyboardEventForm.cs
â”‚   â”‚   â”œâ”€â”€ EditMouseEventForm.cs
â”‚   â”‚   â”œâ”€â”€ EditDelayEventForm.cs
â”‚   â”‚   â”œâ”€â”€ EditScriptEventForm.cs
â”‚   â”‚   â””â”€â”€ EditFlowControlEventForm.cs
â”‚   â”œâ”€â”€ Models/                # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ AppState.cs
â”‚   â”‚   â”œâ”€â”€ PlaybackConfiguration.cs
â”‚   â”‚   â””â”€â”€ Events/            # äº‹ä»¶ç±»å‹å®šä¹‰
â”‚   â”‚       â”œâ”€â”€ MacroEvent.cs  # äº‹ä»¶åŸºç±»
â”‚   â”‚       â”œâ”€â”€ KeyboardEvent.cs
â”‚   â”‚       â”œâ”€â”€ MouseEvent.cs
â”‚   â”‚       â”œâ”€â”€ DelayEvent.cs
â”‚   â”‚       â”œâ”€â”€ ScriptEvent.cs
â”‚   â”‚       â”œâ”€â”€ JumpEvent.cs
â”‚   â”‚       â”œâ”€â”€ ConditionalJumpEvent.cs
â”‚   â”‚       â””â”€â”€ BreakEvent.cs
â”‚   â”œâ”€â”€ Services/              # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ RecordingService.cs        # å½•åˆ¶æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ PlaybackService.cs         # å›æ”¾æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ PlaybackContext.cs         # å›æ”¾ä¸Šä¸‹æ–‡
â”‚   â”‚   â”œâ”€â”€ FileService.cs             # æ–‡ä»¶è¯»å†™
â”‚   â”‚   â”œâ”€â”€ HighPrecisionTimer.cs      # é«˜ç²¾åº¦è®¡æ—¶å™¨
â”‚   â”‚   â”œâ”€â”€ IEventPlayer.cs            # äº‹ä»¶æ’­æ”¾å™¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ KeyboardEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ MouseEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ DelayEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ ScriptEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ JumpEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ ConditionalJumpEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ Ch9329KeyboardEventPlayer.cs
â”‚   â”‚   â”œâ”€â”€ Ch9329MouseEventPlayer.cs
â”‚   â”‚   â””â”€â”€ CH9329/            # CH9329 ç¡¬ä»¶æ”¯æŒ
â”‚   â”‚       â”œâ”€â”€ InputSimulator.cs
â”‚   â”‚       â”œâ”€â”€ Ch9329Controller.cs
â”‚   â”‚       â”œâ”€â”€ Ch9329Exception.cs
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ Native/                # Windows API å°è£…
â”‚   â”‚   â”œâ”€â”€ NativeMethods.cs   # P/Invoke å£°æ˜
â”‚   â”‚   â””â”€â”€ InputHook.cs       # é”®ç›˜é¼ æ ‡é’©å­
â”‚   â””â”€â”€ Utils/                 # å·¥å…·ç±»
â”‚
â”œâ”€â”€ MacroScript/               # å‘½ä»¤è¡Œè„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ Program.cs             # å‘½ä»¤è¡Œå…¥å£
â”‚   â”œâ”€â”€ Dsl/                   # DSL ç¼–è¯‘å™¨
â”‚   â”‚   â”œâ”€â”€ Scripting.cs
â”‚   â”‚   â”œâ”€â”€ Lexer.cs           # è¯æ³•åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ NewDslParser.cs    # è¯­æ³•åˆ†æå™¨
â”‚   â”‚   â””â”€â”€ Token.cs
â”‚   â””â”€â”€ *.macroscript          # ç¤ºä¾‹è„šæœ¬æ–‡ä»¶
â”‚
â””â”€â”€ MacroScriptTests/          # å•å…ƒæµ‹è¯•
```

## ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹

### é«˜ç²¾åº¦è®¡æ—¶
ä½¿ç”¨ `QueryPerformanceCounter` å®ç°æ¯«ç§’çº§ç²¾ç¡®å»¶è¿Ÿï¼Œç¡®ä¿äº‹ä»¶å›æ”¾çš„å‡†ç¡®æ€§ã€‚

### ç­–ç•¥æ¨¡å¼
é€šè¿‡ `IEventPlayer` æ¥å£å®ç°ä¸åŒç±»å‹äº‹ä»¶çš„æ’­æ”¾å™¨ï¼Œæ”¯æŒçµæ´»æ‰©å±•ã€‚

### å¤–è§‚æ¨¡å¼
`MacroController` ä½œä¸ºå¤–è§‚ç±»ï¼Œåè°ƒå„ä¸ªæœåŠ¡ä¹‹é—´çš„äº¤äº’ï¼Œç®€åŒ– UI å±‚çš„è°ƒç”¨ã€‚

### ç¡¬ä»¶æŠ½è±¡
æ”¯æŒæœ¬åœ°è¾“å…¥æ¨¡æ‹Ÿå’Œ CH9329 ç¡¬ä»¶é‡å®šå‘ä¸¤ç§æ¨¡å¼ï¼Œè¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢ã€‚

### è¡¨è¾¾å¼å¼•æ“
ä½¿ç”¨ `DynamicExpresso` åº“æ”¯æŒåŠ¨æ€è¡¨è¾¾å¼æ±‚å€¼ï¼Œå®ç°çµæ´»çš„æ¡ä»¶æ§åˆ¶ã€‚

## ğŸ“¦ ä¾èµ–é¡¹

- **DynamicExpresso.Core** (2.19.3) - åŠ¨æ€è¡¨è¾¾å¼æ±‚å€¼
- **System.IO.Ports** (9.0.10) - ä¸²å£é€šä¿¡

## ğŸ® æ”¯æŒçš„æŒ‰é”®å’Œé¼ æ ‡æ“ä½œ

### é¼ æ ‡æŒ‰é’®
- Left (å·¦é”®)
- Right (å³é”®)
- Middle (ä¸­é”®)
- X1, X2 (ä¾§é”®)

### é”®ç›˜æŒ‰é”®
æ”¯æŒæ‰€æœ‰æ ‡å‡† Windows è™šæ‹Ÿé”®ç  (System.Windows.Forms.Keys)ï¼ŒåŒ…æ‹¬ï¼š
- å­—æ¯é”®ï¼šA-Z
- æ•°å­—é”®ï¼šD0-D9, NumPad0-NumPad9
- åŠŸèƒ½é”®ï¼šF1-F24
- ä¿®é¥°é”®ï¼šShift, Ctrl, Alt, Win
- å¯¼èˆªé”®ï¼šHome, End, PageUp, PageDown, Arrow Keys
- ç­‰ç­‰...

è¿è¡Œ `MacroScript.exe showkeys` æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„æŒ‰é”®åç§°ã€‚

## ğŸ“ æ–‡ä»¶æ ¼å¼

å®åºåˆ—ä»¥ XML æ ¼å¼ä¿å­˜ï¼Œç¤ºä¾‹ï¼š

```xml
<MacroEventCollection>
  <MacroEvent Type="MouseEvent" Action="MoveTo" X="400" Y="400" TimeSinceLastEvent="200" />
  <MacroEvent Type="KeyboardEvent" Action="Down" Key="LControlKey" TimeSinceLastEvent="100" />
  <MacroEvent Type="KeyboardEvent" Action="Up" Key="LControlKey" TimeSinceLastEvent="50" />
  <MacroEvent Type="DelayEvent" DelayMilliseconds="1000" TimeSinceLastEvent="0" />
</MacroEventCollection>
```

## ğŸ›¡ï¸ æ³¨æ„äº‹é¡¹

1. **ç®¡ç†å‘˜æƒé™**ï¼šæŸäº›åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œæ‰èƒ½æ­£å¸¸æ¨¡æ‹Ÿè¾“å…¥
2. **ç¡¬ä»¶è®¾å¤‡**ï¼šä½¿ç”¨ CH9329 åŠŸèƒ½éœ€è¦è¿æ¥ç›¸åº”çš„ç¡¬ä»¶è®¾å¤‡
3. **å®‰å…¨æ€§**ï¼šè‡ªåŠ¨åŒ–è„šæœ¬å¯èƒ½ä¼šå¹²æ‰°ç³»ç»Ÿæ“ä½œï¼Œè¯·è°¨æ…ä½¿ç”¨
4. **å¾ªç¯æ§åˆ¶**ï¼šé¿å…åˆ›å»ºæ— é™å¾ªç¯ï¼Œå»ºè®®æ·»åŠ é€‚å½“çš„é€€å‡ºæ¡ä»¶

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä¸ºä¸ªäººå¼€æºé¡¹ç›®ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ GitHub Issues åé¦ˆã€‚

---

**MacroCreator** - è®©è‡ªåŠ¨åŒ–æ›´ç®€å•ï¼